<!DOCTYPE html>
<html>
<head>
<link rel="stylesheet" href="style.css">

<script language="javascript">
     
    function sd(d){
        h="URL    : ";
        document.getElementById('u').innerHTML=h + " " + d;
    }
    
    let confno="%cnn%";
    let t = Date.now();
    let to = 0;
 
    function updatestatus(){
        xmlhttp = new XMLHttpRequest();
        xmlhttp.open("POST", "/status", true);
        xmlhttp.setRequestHeader('Content-Type', 'application/json')
        xmlhttp.onreadystatechange = function () {
            if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
                try {
                    JSON.parse(xmlhttp.responseText);
                }
                catch(ex) {
                    return false;
                }
                let o = JSON.parse(xmlhttp.responseText);
                document.getElementById('st').innerHTML = o.status;
                if (o.app==2){
                    window.location.href = "/wipe";
                }
                if (o.cnn != confno){
                    window.location.reload();
                }
                setTimeout(updatestatus, 300);
            }
        };
        xmlhttp.send("{\"a\":0}");
    }

    function updateform(url, data){
        xmlhttp = new XMLHttpRequest();
        xmlhttp.open("POST", url, true);
        xmlhttp.setRequestHeader('Content-Type', 'application/json')
        xmlhttp.onreadystatechange = function () {
            if (xmlhttp.readyState == 4 && xmlhttp.status == 200) {
                try {
                    JSON.parse(xmlhttp.responseText);
                }
                catch(ex) {
                    return false;
                }
                let o = JSON.parse(xmlhttp.responseText);
                document.getElementById('st').innerHTML = o.status;
                if (o.app==2){
                    window.location.href = "/wipe";
                }
                if (o.cnn != confno){
                    window.location.reload();
                }
                setTimeout(updatestatus, 300);
            }
        };
        xmlhttp.send(JSON.stringify(data));
    }

    window.onload = function() {
        setTimeout(updatestatus, 300);
        let i = document.getElementById('ki');
        //modal
        document.addEventListener('click', function (e) {
            console.log(e);
            e = e || window.event;
            var target = e.target || e.srcElement;
            if (target.hasAttribute('data-toggle') && target.getAttribute('data-toggle') == 'modal') {
                if (target.hasAttribute('data-target')) {
                    var m_ID = target.getAttribute('data-target');
                    document.getElementById(m_ID).classList.add('open');
                    e.preventDefault();
                }
            }
            if (target.type == 'button'){
                fe = target.form.elements;
                console.log(fe);
                let data = {}
                for (i=0; i<fe.length; i++){
                    if (fe[i].type == "radio"){
                        if (fe[i].checked){
                            data[fe[i].name] = fe[i].value;
                        }
                    }
                    else{
                        data[fe[i].id] = fe[i].value;
                    }
                }
                if (target.form.hasAttribute("data-t")){
                    url = target.form.getAttribute("data-t");
                    console.log(url);
                    updateform(url, data);
                }
            }
            // Close modal window with 'data-dismiss' attribute or when the backdrop is clicked
            if ((target.hasAttribute('data-dismiss') && target.getAttribute('data-dismiss') == 'modal') || target.classList.contains('modal')) {
                var modal = document.querySelector('[class="modal open"]');
                modal.classList.remove('open');
                e.preventDefault();
            }
        }, false);   
    }

</script>
</head>
<body>
<div class="form">
<input type hidden id="keys" type="">
<div class="sel">
</div>
<div class="head m">
<div class="sel">
    <div class="me l" id="dev" ><a class="il" href="/setup">setup</a></div>
    <div class="me m" id="burn"><a class="il" href="/">burn</a></div>
    <div class="me r" id="wipe"><a class="il" href="/wipe">wipe</a></div>
</div>
<b>BoltRing - %job% NFC-device</b><br />
Hold a NTAG424 against the reader.
<div class="name"><a class="dev" href="?d=p"><</a>%cnn%. %cn%<a class="dev" href="?d=n">></a></div> 
</div>
<div class="data">
<div class="nfc" id="st"><div class="spin"></div></div>   
</div>
<div class="info">
<div class="k" id="u">
URL: %url%
</div>
<div class="k" id="k0">
Key 0: %k0%
</div>
<div class="k" id="k1">
Key 1: %k1%
</div>
<div class="k" id="k2">
Key 2: %k2%
</div>
<div class="k" id="k3">
Key 3: %k3%
</div>
<div class="k" id="k4">
Key 4: %k4%
</div>
</div>
<div class="button">
</div>
</div>
</body>
</html>
